<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>أداة توقع الشمعة القادمة</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg p-6">
    <h1 class="text-2xl font-bold mb-4 text-center">🔮 أداة توقع اتجاه الشمعة القادمة (5 دقائق)</h1><div class="mb-4">
  <label class="block mb-1 font-medium">اختر زوج العملة:</label>
  <select id="pair" class="w-full p-2 border rounded">
    <option value="btcusdt">BTC/USDT</option>
    <option value="ethusdt">ETH/USDT</option>
    <option value="bnbusdt">BNB/USDT</option>
  </select>
</div>

<button onclick="analyze()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">🔍 تحليل</button>

<div id="result" class="mt-6 hidden">
  <h2 class="text-xl font-semibold mb-2">📊 نتيجة التوقع:</h2>
  <p><strong>الشمعة التالية:</strong> <span id="direction" class="font-bold"></span></p>
  <p><strong>نسبة الثقة:</strong> <span id="confidence"></span>%</p>
  <p><strong>السبب:</strong> <span id="reason"></span></p>
</div>

<div class="mt-10">
  <h2 class="text-xl font-semibold mb-2 text-center">📈 الرسم البياني المباشر</h2>
  <div class="border rounded-xl overflow-hidden">
    <iframe id="tvchart" src="https://www.tradingview.com/chart/?symbol=BINANCE:BTCUSDT" height="500" width="100%" frameborder="0" allowfullscreen></iframe>
  </div>
</div>

<p class="text-xs text-gray-500 mt-6 text-center">⚠️ هذه الأداة تقدم تحليل فني باستخدام بيانات حية من Binance. ليست نصيحة مالية.</p>

  </div>  <script>
    async function analyze() {
      const pair = document.getElementById("pair").value;
      const limit = 100;

      // تحديث الرسم البياني
      document.getElementById("tvchart").src = `https://www.tradingview.com/chart/?symbol=BINANCE:${pair.toUpperCase()}`;

      try {
        const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${pair.toUpperCase()}&interval=5m&limit=${limit}`);
        const data = await response.json();

        const closes = data.map(d => parseFloat(d[4]));
        const highs = data.map(d => parseFloat(d[2]));
        const lows = data.map(d => parseFloat(d[3]));

        let gains = 0, losses = 0;
        for (let i = 1; i < closes.length; i++) {
          const change = closes[i] - closes[i - 1];
          if (change > 0) gains += change;
          else losses -= change;
        }
        const avgGain = gains / (closes.length - 1);
        const avgLoss = losses / (closes.length - 1);
        const rs = avgGain / avgLoss;
        const rsi = 100 - (100 / (1 + rs));

        const smaFast = closes.slice(-5).reduce((a, b) => a + b) / 5;
        const smaSlow = closes.slice(-20).reduce((a, b) => a + b) / 20;

        const lastClose = closes[closes.length - 1];
        const highestHigh = Math.max(...highs.slice(-14));
        const lowestLow = Math.min(...lows.slice(-14));
        const stochastic = ((lastClose - lowestLow) / (highestHigh - lowestLow)) * 100;

        const ema = (arr, period) => {
          const k = 2 / (period + 1);
          let emaArr = [arr.slice(0, period).reduce((a, b) => a + b) / period];
          for (let i = period; i < arr.length; i++) {
            emaArr.push(arr[i] * k + emaArr[emaArr.length - 1] * (1 - k));
          }
          return emaArr;
        };
        const macdLine = ema(closes, 12).slice(-1)[0] - ema(closes, 26).slice(-1)[0];

        let direction, confidence, reasons = [];

        if (rsi < 30 && stochastic < 20 && macdLine > 0 && smaFast > smaSlow) {
          direction = "شراء (LONG)";
          confidence = 90;
          reasons.push("RSI منخفض (تشبع بيعي)");
          reasons.push("Stochastic منخفض (تشبع بيعي)");
          reasons.push("MACD إيجابي");
          reasons.push("SMA يشير لصعود");
        } else if (rsi > 70 && stochastic > 80 && macdLine < 0 && smaFast < smaSlow) {
          direction = "بيع (SHORT)";
          confidence = 90;
          reasons.push("RSI مرتفع (تشبع شرائي)");
          reasons.push("Stochastic مرتفع (تشبع شرائي)");
          reasons.push("MACD سلبي");
          reasons.push("SMA يشير لهبوط");
        } else if (macdLine > 0 && smaFast > smaSlow) {
          direction = "شراء (LONG)";
          confidence = 75;
          reasons.push("MACD إيجابي");
          reasons.push("الاتجاه العام صاعد");
        } else if (macdLine < 0 && smaFast < smaSlow) {
          direction = "بيع (SHORT)";
          confidence = 75;
          reasons.push("MACD سلبي");
          reasons.push("الاتجاه العام هابط");
        } else {
          direction = "محايد";
          confidence = 50;
          reasons.push("لا توجد إشارات واضحة حالياً");
        }

        document.getElementById("direction").textContent = direction;
        document.getElementById("confidence").textContent = confidence;
        document.getElementById("reason").textContent = reasons.join("؛ ");
        document.getElementById("result").classList.remove("hidden");

      } catch (error) {
        alert("فشل في جلب البيانات من Binance. الرجاء المحاولة مرة أخرى.");
        console.error(error);
      }
    }
  </script></body>
</html>
