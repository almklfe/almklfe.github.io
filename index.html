<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>أداة التنبؤ باتجاه الشمعة القادمة - Binance</title>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      direction: rtl;
      background-color: #f5f5f5;
      padding: 20px;
    }
    .tool-container {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #3b82f6;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #2563eb;
    }
    .result {
      margin-top: 20px;
      background: #f0f9ff;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #d1eaff;
    }
    .loading {
      text-align: center;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="tool-container">
    <h2>🔍 أداة تحليل الشمعة القادمة - Binance</h2>

    <label for="pair">اختر زوج العملة:</label>
    <select id="pair">
      <option value="btcusdt">BTC/USDT</option>
      <option value="ethusdt">ETH/USDT</option>
      <option value="bnbusdt">BNB/USDT</option>
      <option value="solusdt">SOL/USDT</option>
      <option value="xrpusdt">XRP/USDT</option>
      <option value="dogeusdt">DOGE/USDT</option>
      <option value="adausdt">ADA/USDT</option>
      <option value="trxusdt">TRX/USDT</option>
    </select>

    <button onclick="analyzeCandle()">🔍 تحليل</button>

    <div class="loading" id="loading">📡 جاري جلب البيانات الحية...</div>
    <div class="result" id="result" style="display:none;"></div>
  </div>

  <script>
    let socket;
    let latestCandle;

    function connectWebSocket(pair) {
      if (socket) socket.close();
      const url = `wss://stream.binance.com:9443/ws/${pair}@kline_5m`;
      socket = new WebSocket(url);
      socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        if (data.k && !data.k.x) {
          latestCandle = data.k; // الشمعة قيد التكوين
        }
      };
    }

    function analyzeCandle() {
      const resultBox = document.getElementById("result");
      resultBox.style.display = "block";
      if (!latestCandle) {
        resultBox.innerHTML = "⚠️ لا توجد بيانات حية حالياً. انتظر قليلاً ثم حاول مرة أخرى.";
        return;
      }

      const open = parseFloat(latestCandle.o);
      const close = parseFloat(latestCandle.c);
      const high = parseFloat(latestCandle.h);
      const low = parseFloat(latestCandle.l);
      const volume = parseFloat(latestCandle.v);

      let direction = "شراء";
      let confidence = 50;
      let reason = "";

      const body = Math.abs(close - open);
      const candleSize = high - low;
      const upperWick = high - Math.max(open, close);
      const lowerWick = Math.min(open, close) - low;

      if (close < open) {
        direction = "بيع";
      }

      if (body / candleSize > 0.6) {
        confidence = 85;
        reason = "جسم شمعة كبير واتجاه واضح في السوق مع زخم مرتفع.";
      } else if (body / candleSize > 0.3) {
        confidence = 70;
        reason = "شمعة باتجاه متوسط مع احتمال استمرار الاتجاه الحالي.";
      } else {
        confidence = 55;
        reason = "شمعة تذبذب مع فتائل طويلة قد تشير لتغير في الاتجاه.";
      }

      resultBox.innerHTML = `
        <strong>🔮 الشمعة التالية:</strong> ${direction}<br>
        <strong>📊 نسبة الثقة:</strong> ${confidence}%<br>
        <strong>📌 السبب:</strong> ${reason}
      `;
    }

    const pairSelector = document.getElementById("pair");
    pairSelector.addEventListener("change", function () {
      document.getElementById("loading").style.display = "block";
      latestCandle = null;
      connectWebSocket(this.value);
      setTimeout(() => {
        document.getElementById("loading").style.display = "none";
      }, 3000);
    });

    // الاتصال الأولي
    connectWebSocket(pairSelector.value);
    setTimeout(() => {
      document.getElementById("loading").style.display = "none";
    }, 3000);
  </script>
</body>
</html>
