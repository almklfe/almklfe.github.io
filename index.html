<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>أداة الذكاء الاصطناعي لتحليل الشموع</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --dark: #212529;
      --light: #f8f9fa;
      --danger: #f72585;
      --warning: #f8961e;
      --upload: #7209b7;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Tahoma', Arial, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      min-height: 100vh;
      padding: 2rem;
      color: var(--dark);
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
    }
    
    .card-header {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      padding: 1.5rem;
      text-align: center;
      position: relative;
    }
    
    .card-header h2 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    
    .card-header p {
      opacity: 0.9;
      font-size: 0.9rem;
    }
    
    .card-body {
      padding: 2rem;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .connected {
      background-color: rgba(76, 201, 240, 0.2);
      color: #0a9396;
      border: 1px solid #4cc9f0;
    }
    
    .disconnected {
      background-color: rgba(247, 37, 133, 0.1);
      color: var(--danger);
      border: 1px solid var(--danger);
    }
    
    .upload-area {
      border: 2px dashed #ddd;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      margin-bottom: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .upload-area:hover {
      border-color: var(--primary);
      background: rgba(67, 97, 238, 0.05);
    }
    
    .upload-area i {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 1rem;
    }
    
    .upload-area p {
      margin-bottom: 0.5rem;
    }
    
    .upload-area input[type="file"] {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }
    
    .btn {
      display: inline-block;
      padding: 0.8rem 1.8rem;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
      width: 100%;
      margin-bottom: 10px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    .loading i {
      font-size: 2rem;
      color: var(--primary);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .result {
      display: none;
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1.5rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      border: 1px solid #eee;
    }
    
    .result-item {
      display: flex;
      justify-content: space-between;
      padding: 0.8rem 0;
      border-bottom: 1px solid #eee;
    }
    
    .result-item:last-child {
      border-bottom: none;
    }
    
    .result-item strong {
      color: var(--primary);
      font-weight: bold;
    }
    
    .result-value {
      color: #555;
      font-weight: normal;
    }
    
    .signal-call {
      color: #2ecc71;
      font-weight: bold;
    }
    
    .signal-put {
      color: var(--danger);
      font-weight: bold;
    }
    
    .confidence-bar {
      height: 8px;
      background: #eee;
      border-radius: 4px;
      margin-top: 0.5rem;
      overflow: hidden;
    }
    
    .confidence-level {
      height: 100%;
      background: linear-gradient(to right, #f72585, #4361ee);
      border-radius: 4px;
    }
    
    .stats-container {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #eee;
    }
    
    .stats-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    
    .stats-bar {
      height: 8px;
      background: #eee;
      border-radius: 4px;
      margin-top: 0.3rem;
      overflow: hidden;
    }
    
    .stats-correct {
      background: #2ecc71;
      height: 100%;
    }
    
    .stats-incorrect {
      background: #e74c3c;
      height: 100%;
    }

    .new-analysis-btn {
      background: linear-gradient(to right, #f8961e, #f3722c);
      margin-top: 1rem;
    }

    .validation-buttons {
      display: flex;
      gap: 10px;
      margin-top: 1rem;
    }

    .validation-btn {
      flex: 1;
      padding: 0.5rem;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
    }

    .correct-btn {
      background: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
      border: 1px solid #2ecc71;
    }

    .incorrect-btn {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border: 1px solid #e74c3c;
    }

    .error-message {
      color: var(--danger);
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      background: rgba(247, 37, 133, 0.1);
      border: 1px solid var(--danger);
      margin-bottom: 1rem;
    }

    .preview-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .preview-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 90%;
      max-height: 90%;
      text-align: center;
    }

    .preview-content img {
      max-width: 100%;
      max-height: 80vh;
      border: 1px solid #ddd;
    }

    .close-preview {
      margin-top: 15px;
      padding: 8px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* أنماط أشرطة التقدم */
    .progress-container {
      width: 100%;
      background: #f0f0f0;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    #uploadProgressContainer {
      background: rgba(114, 9, 183, 0.1);
      border-left: 4px solid var(--upload);
      padding: 10px;
    }

    .progress-bar {
      height: 8px;
      transition: width 0.5s ease;
    }

    #uploadProgressBar {
      background: linear-gradient(90deg, #7209b7, #b5179e);
    }

    #progressBar {
      background: linear-gradient(90deg, #4361ee, #3a0ca3);
    }

    .progress-text {
      display: block;
      text-align: center;
      margin-top: 5px;
      font-weight: bold;
    }

    #uploadProgressText {
      color: #7209b7;
    }

    #progressText {
      color: #4361ee;
    }

    #stageDetails {
      padding: 8px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 3px solid #4361ee;
      margin-top: 10px;
      font-size: 13px;
      color: #555;
    }

    .progress-label {
      font-weight: bold;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }
      
      .card-header h2 {
        font-size: 1.5rem;
      }
      
      .card-body {
        padding: 1.5rem;
      }

      .validation-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h2><i class="fas fa-chart-line"></i> أداة الذكاء الاصطناعي لتحليل الشموع</h2>
        <p>تحليل احترافي للشمعة التالية بناءً على المؤشرات الفنية</p>
      </div>
      
      <div class="card-body">
        <div id="connectionStatus" class="connection-status disconnected">
          <i class="fas fa-plug"></i> جاري التحقق من اتصال النموذج...
        </div>
        
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
          <i class="fas fa-cloud-upload-alt"></i>
          <h3>اسحب وأفلت صورة الشارت هنا</h3>
          <p>أو انقر لاختيار صورة</p>
          <input type="file" id="fileInput" accept="image/*" style="display: none;">
        </div>
        
        <button id="previewBtn" class="btn" onclick="previewImage()" disabled>
          <i class="fas fa-eye"></i> معاينة الصورة
        </button>

        <button id="analyzeBtn" class="btn" onclick="analyzeImage()" disabled>
          <i class="fas fa-search"></i> بدء التحليل
        </button>

        <button id="newAnalysisBtn" class="btn new-analysis-btn" onclick="resetAnalysis()" style="display: none;">
          <i class="fas fa-sync-alt"></i> تحليل جديد
        </button>
        
        <!-- شريط تقدم تحميل الصورة -->
        <div class="progress-container" id="uploadProgressContainer" style="display: none;">
          <div class="progress-label">
            <span>تحميل الصورة:</span>
            <span id="uploadProgressText">0%</span>
          </div>
          <div class="progress-bar" id="uploadProgressBar" style="width: 0%"></div>
        </div>
        
        <!-- شريط تقدم التحليل الرئيسي -->
        <div id="loadingIndicator" class="loading" style="display: none;">
          <i class="fas fa-circle-notch fa-spin"></i>
          <p id="loadingMessage">جاري الإعداد...</p>
          <div class="progress-container">
            <div class="progress-label">
              <span>تقدم التحليل:</span>
              <span id="progressText">0%</span>
            </div>
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
          </div>
          <div id="stageDetails"></div>
        </div>

        <div id="errorContainer" class="error-message" style="display: none;"></div>
        
        <div class="result" id="resultBox">
          <div class="result-item">
            <strong>اسم الزوج:</strong>
            <span id="pair" class="result-value">جاري التحليل...</span>
          </div>
          
          <div class="result-item">
            <strong>الشمعة التالية:</strong>
            <span id="signal" class="result-value">جاري التحليل...</span>
          </div>
          
          <div class="result-item">
            <strong>نسبة الثقة:</strong>
            <div style="width: 100%;">
              <span id="confidence" class="result-value">جاري التحليل...</span>
              <div class="confidence-bar">
                <div id="confidenceBar" class="confidence-level" style="width: 0%"></div>
              </div>
            </div>
          </div>
          
          <div class="result-item">
            <strong>الدعم والمقاومة:</strong>
            <span id="supportResistance" class="result-value">جاري التحليل...</span>
          </div>
          
          <div class="result-item">
            <strong>الاسباب:</strong>
            <span id="reason" class="result-value">جاري التحليل...</span>
          </div>
          
          <div class="stats-container" id="statsContainer">
            <h4><i class="fas fa-chart-pie"></i> إحصائيات الدقة</h4>
            <div class="stats-item">
              <span>النتائج الصحيحة:</span>
              <span id="correctCount">0</span>
            </div>
            <div class="stats-bar">
              <div id="correctBar" class="stats-correct" style="width: 0%"></div>
            </div>
            
            <div class="stats-item">
              <span>النتائج الخاطئة:</span>
              <span id="incorrectCount">0</span>
            </div>
            <div class="stats-bar">
              <div id="incorrectBar" class="stats-incorrect" style="width: 0%"></div>
            </div>
          </div>

          <div class="validation-buttons" id="validationButtons" style="display: none;">
            <div class="validation-btn correct-btn" onclick="validateResult(true)">
              <i class="fas fa-check"></i> التحليل صحيح
            </div>
            <div class="validation-btn incorrect-btn" onclick="validateResult(false)">
              <i class="fas fa-times"></i> التحليل خاطئ
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentBase64Image = null;
    let currentImageMetadata = {};
    const MAX_WIDTH = 800;
    const QUALITY = 0.85;
    let uploadCancelled = false;

    const arabicPrompt = `أنت خبير ومحليل فني محترف في تحليل صور الرسوم البيانية لأسواق الفوركس. قم بتحليل صورة الشارت المرفقة من منصة Pocket Option على الإطار الزمني M3، وقدم توقعًا لاتجاه الشمعة القادمة فقط (إما شراء أو بيع) مع نسبة الثقة، وذلك بالاعتماد على:

1- حركة السعر:
- اتجاه وقوة الشمعة الحالية (حجم الجسم، الظلال، حجم التداول)
- سلوك آخر 3-5 شموع قبل الشمعة الحالية

2- المستويات السعرية:
- تحديد أقرب مستوى مقاومة
- تحديد أقرب مستوى دعم

3- النماذج الشمعية:
- Pin Bar
- Engulfing
- Doji

4- المؤشرات الفنية الظاهرة في الشارت:
- المتوسط المتحرك الأسي EMA 9
- مؤشر MACD (6,13,5)
- مؤشر Stochastic (5,3,3)

5- تقاطعات المؤشرات المختلفة:
- تقاطع EMA 9 مع السعر (أعلى/أسفل)
- تقاطع خطوط الـ MACD (الإشارة مع الخط الرئيسي)
- تقاطع خطوط الـ Stochastic (الإشارة مع الخط الرئيسي)
- تناغم المؤشرات مع بعضها (التأكيدات أو التناقضات)

قدم النتيجة بهذا التنسيق:
{
  "pair": "اسم الزوج",
  "signal": "شراء أو بيع",
  "confidence": "النسبة بين 0-100",
  "supportResistance": "أقرب دعم ومقاومة",
  "reason": "شرح مختصر (50 كلمة كحد أقصى) يشمل تحليل حركة السعر والمؤشرات"
}`;

    async function processImage(file) {
      return new Promise((resolve, reject) => {
        uploadCancelled = false;
        const img = new Image();
        const reader = new FileReader();
        
        // إظهار شريط تحميل الصورة
        document.getElementById("uploadProgressContainer").style.display = "block";
        updateUploadProgress(10, "جاري قراءة الملف...");
        
        reader.onload = async (e) => {
          if (uploadCancelled) {
            reject(new Error("تم إلغاء تحميل الصورة"));
            return;
          }
          
          updateUploadProgress(30, "جاري تحميل البيانات...");
          
          img.onload = async () => {
            if (uploadCancelled) {
              reject(new Error("تم إلغاء تحميل الصورة"));
              return;
            }
            
            updateUploadProgress(50, "جاري معالجة الصورة...");
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            let width = img.naturalWidth;
            let height = img.naturalHeight;
            
            if (width > MAX_WIDTH) {
              const ratio = MAX_WIDTH / width;
              width = MAX_WIDTH;
              height = Math.floor(height * ratio);
            }
            
            canvas.width = width;
            canvas.height = height;
            
            ctx.drawImage(img, 0, 0, width, height);
            
            updateUploadProgress(70, "جاري ضغط الصورة...");
            
            // تأخير لمحاكاة عملية الضغط
            await new Promise(resolve => setTimeout(resolve, 500));
            
            canvas.toBlob((blob) => {
              if (!blob) {
                reject(new Error("فشل في معالجة الصورة"));
                return;
              }
              
              updateUploadProgress(90, "جاري تحويل الصورة...");
              
              const newReader = new FileReader();
              newReader.onload = () => {
                updateUploadProgress(100, "اكتمل التحميل بنجاح!");
                setTimeout(() => {
                  document.getElementById("uploadProgressContainer").style.display = "none";
                }, 1000);
                
                resolve({
                  dataUrl: newReader.result,
                  width: width,
                  height: height,
                  size: (blob.size / (1024 * 1024)).toFixed(2) + 'MB',
                  type: file.type
                });
              };
              newReader.readAsDataURL(blob);
            }, file.type, QUALITY);
          };
          
          img.onerror = () => {
            reject(new Error("فشل في تحميل الصورة"));
          };
          
          img.src = e.target.result;
        };
        
        reader.onerror = () => {
          reject(new Error("فشل في قراءة الملف"));
        };
        
        reader.readAsDataURL(file);
      });
    }

    function updateUploadProgress(percent, message) {
      document.getElementById("uploadProgressBar").style.width = `${percent}%`;
      document.getElementById("uploadProgressText").textContent = `${percent}%`;
      document.querySelector("#uploadProgressContainer .progress-label span:first-child").textContent = message;
    }

    function cancelUpload() {
      uploadCancelled = true;
      document.getElementById("uploadProgressContainer").style.display = "none";
      resetFileInput();
      showError("تم إلغاء تحميل الصورة");
    }

    document.addEventListener('DOMContentLoaded', async function() {
      checkConnection();
      updateStatisticsDisplay();
      
      document.getElementById('fileInput').addEventListener('change', async function(e) {
        if (e.target.files.length > 0) {
          try {
            const file = e.target.files[0];
            
            if (!file.type.match('image.*')) {
              throw new Error("الملف ليس صورة!");
            }

            if (file.size > 15 * 1024 * 1024) {
              throw new Error("حجم الصورة كبير جداً (الحد الأقصى 15MB)");
            }

            const processedImage = await processImage(file);
            currentBase64Image = processedImage.dataUrl;
            currentImageMetadata = {
              dimensions: `${processedImage.width}×${processedImage.height} بكسل`,
              size: processedImage.size,
              type: processedImage.type
            };
            
            document.getElementById('previewBtn').disabled = false;
            document.getElementById('analyzeBtn').disabled = false;
            
          } catch (error) {
            if (!uploadCancelled) {
              showError(error.message);
            }
            resetFileInput();
          }
        }
      });
    });

    function previewImage() {
      if (!currentBase64Image) {
        showError("❗ لم يتم تحميل صورة للمعاينة");
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'preview-modal';
      modal.innerHTML = `
        <div class="preview-content">
          <h3>معاينة الصورة <small>(${currentImageMetadata.dimensions})</small></h3>
          <img src="${currentBase64Image}" alt="معاينة الصورة">
          <button class="close-preview" onclick="this.parentElement.parentElement.remove()">
            <i class="fas fa-times"></i> إغلاق
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.style.display = 'flex';
      
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    function resetFileInput() {
      const fileInput = document.getElementById('fileInput');
      fileInput.value = '';
      currentBase64Image = null;
      currentImageMetadata = {};
      document.getElementById('previewBtn').disabled = true;
      document.getElementById('analyzeBtn').disabled = true;
      document.querySelector('.upload-area h3').textContent = 'اسحب وأفلت صورة الشارت هنا';
      document.querySelector('.upload-area p').textContent = 'أو انقر لاختيار صورة';
    }
    
    function resetAnalysis() {
      resetFileInput();
      document.getElementById('resultBox').style.display = 'none';
      document.getElementById('newAnalysisBtn').style.display = 'none';
      document.getElementById('errorContainer').style.display = 'none';
      document.getElementById('uploadProgressContainer').style.display = 'none';
    }
    
    async function checkConnection() {
      const statusElement = document.getElementById("connectionStatus");
      try {
        statusElement.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> جاري الاتصال بالنموذج...';
        
        const testResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash?key=AIzaSyBrYzeXqyKs4OqBWuc9_uLc3fEtBihQwD0`);
        
        if (testResponse.ok) {
          statusElement.innerHTML = '<i class="fas fa-check-circle"></i> متصل بنموذج Gemini 2.0 Flash';
          statusElement.className = "connection-status connected";
        } else {
          const errorData = await testResponse.json();
          throw new Error(errorData.error.message || "فشل الاتصال بالنموذج");
        }
      } catch (error) {
        statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> غير متصل: ' + error.message;
        statusElement.className = "connection-status disconnected";
        console.error("Connection Error:", error);
      }
    }

    async function analyzeImage() {
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];
      
      try {
        if (!file) throw new Error("❗ يرجى اختيار صورة الشارت أولاً");
      } catch (error) {
        showError(error.message);
        return;
      }

      const loadingIndicator = document.getElementById("loadingIndicator");
      const analyzeBtn = document.getElementById("analyzeBtn");
      loadingIndicator.style.display = "block";
      analyzeBtn.disabled = true;
      analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحليل...';
      document.getElementById("resultBox").style.display = "none";
      document.getElementById("errorContainer").style.display = "none";

      try {
        // تعريف مراحل التحليل مع أوزانها
        const stages = [
          { weight: 15, text: "تحميل الصورة ومعالجتها" },
          { weight: 25, text: "تحليل الشموع والنماذج" },
          { weight: 35, text: "تحليل المؤشرات الفنية" },
          { weight: 25, text: "توليد التوصيات" }
        ];

        let totalProgress = 0;
        
        // دالة تحديث التقدم
        const updateProgress = (stage) => {
          totalProgress += stage.weight;
          document.getElementById("progressBar").style.width = `${totalProgress}%`;
          document.getElementById("progressText").textContent = `${totalProgress}%`;
          document.getElementById("loadingMessage").textContent = "جاري التحليل...";
          document.getElementById("stageDetails").textContent = stage.text;
        };

        // --- المرحلة 1: معالجة الصورة ---
        updateProgress(stages[0]);
        const base64 = currentBase64Image.split(",")[1];
        
        // --- المرحلة 2: تحليل الشموع ---
        updateProgress(stages[1]);
        // محاكاة عملية التحليل
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // --- المرحلة 3: اتصال API الرئيسي ---
        updateProgress(stages[2]);
        const apiKey = "AIzaSyBrYzeXqyKs4OqBWuc9_uLc3fEtBihQwD0";
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    { inlineData: { mimeType: "image/jpeg", data: base64 } },
                    { text: arabicPrompt }
                  ]
                }
              ]
            })
          }
        );

        // --- المرحلة 4: معالجة النتائج ---
        updateProgress(stages[3]);
        const result = await response.json();
        const extractedData = extractAnalysisData(result.candidates[0].content.parts[0].text);
        
        // إكمال التقدم إلى 100%
        document.getElementById("progressBar").style.width = "100%";
        document.getElementById("progressText").textContent = "100%";
        document.getElementById("stageDetails").textContent = "اكتمل التحليل بنجاح!";
        
        // عرض النتائج
        displayResults(extractedData);
        document.getElementById("connectionStatus").innerHTML = '<i class="fas fa-check-circle"></i> اتصال ناجح بالنموذج';
        document.getElementById("connectionStatus").className = "connection-status connected";
        document.getElementById("newAnalysisBtn").style.display = "block";
        document.getElementById("validationButtons").style.display = "flex";
        
      } catch (error) {
        console.error("Error:", error);
        showError(`❌ خطأ في التحليل: ${error.message}`);
        document.getElementById("connectionStatus").innerHTML = '<i class="fas fa-exclamation-triangle"></i> فشل في الاتصال';
        document.getElementById("connectionStatus").className = "connection-status disconnected";
        
        // في حالة الخطأ، إظهار الحالة الأخيرة
        document.getElementById("progressBar").style.background = "#f72585";
        document.getElementById("stageDetails").textContent = "حدث خطأ: " + error.message;
      } finally {
        loadingIndicator.style.display = "none";
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i class="fas fa-search"></i> بدء التحليل';
      }
    }

    function extractAnalysisData(text) {
      try {
        const jsonStart = text.indexOf('{');
        const jsonEnd = text.lastIndexOf('}') + 1;
        if (jsonStart < 0 || jsonEnd <= 0) {
          throw new Error("لا يوجد تحليل بتنسيق JSON في الاستجابة");
        }
        
        const jsonString = text.slice(jsonStart, jsonEnd);
        const data = JSON.parse(jsonString);
        
        const requiredFields = ['pair', 'signal', 'confidence', 'supportResistance', 'reason'];
        const missingFields = requiredFields.filter(field => !data[field]);
        if (missingFields.length > 0) {
          throw new Error(`بيانات ناقصة: ${missingFields.join(', ')}`);
        }
        
        if (!['شراء', 'بيع'].includes(data.signal)) {
          throw new Error(`إشارة غير صالحة: ${data.signal}`);
        }
        
        const confidence = parseInt(data.confidence);
        if (isNaN(confidence) || confidence < 0 || confidence > 100) {
          throw new Error(`نسبة الثقة غير صالحة: ${data.confidence}`);
        }
        
        return {
          pair: data.pair.trim(),
          signal: data.signal.trim(),
          confidence: confidence,
          supportResistance: data.supportResistance.trim(),
          reason: data.reason.trim()
        };
      } catch (e) {
        throw new Error(`تعذر تحليل استجابة النموذج: ${e.message}`);
      }
    }

    function displayResults(data) {
      document.getElementById("pair").textContent = data.pair || "غير معروف";
      
      const signalElement = document.getElementById("signal");
      signalElement.textContent = data.signal;
      signalElement.className = data.signal === "شراء" ? "signal-call" : "signal-put";
      
      document.getElementById("confidence").textContent = data.confidence;
      document.getElementById("confidenceBar").style.width = data.confidence + "%";
      
      document.getElementById("supportResistance").textContent = data.supportResistance;
      document.getElementById("reason").textContent = data.reason;
      
      document.getElementById("resultBox").style.display = "block";
    }

    function showError(message) {
      const errorContainer = document.getElementById("errorContainer");
      errorContainer.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
      errorContainer.style.display = "block";
    }

    function getStatistics() {
      const defaultStats = { correct: 0, incorrect: 0 };
      const savedStats = localStorage.getItem('candleAnalysisStats');
      return savedStats ? JSON.parse(savedStats) : defaultStats;
    }
    
    function updateStatisticsDisplay() {
      const stats = getStatistics();
      document.getElementById("correctCount").textContent = stats.correct;
      document.getElementById("incorrectCount").textContent = stats.incorrect;
      
      const total = stats.correct + stats.incorrect;
      if (total > 0) {
        document.getElementById("correctBar").style.width = `${(stats.correct / total) * 100}%`;
        document.getElementById("incorrectBar").style.width = `${(stats.incorrect / total) * 100}%`;
      }
    }
    
    function validateResult(isCorrect) {
      const stats = getStatistics();
      
      if (isCorrect) {
        stats.correct += 1;
        showMessage("تم تسجيل التحليل كصحيح", "success");
      } else {
        stats.incorrect += 1;
        showMessage("تم تسجيل التحليل كخاطئ", "error");
      }
      
      localStorage.setItem('candleAnalysisStats', JSON.stringify(stats));
      updateStatisticsDisplay();
    }
    
    function showMessage(message, type) {
      const messageElement = document.createElement('div');
      messageElement.className = `validation-message ${type}`;
      messageElement.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'times'}"></i> ${message}`;
      
      const validationButtons = document.getElementById("validationButtons");
      validationButtons.parentNode.insertBefore(messageElement, validationButtons.nextSibling);
      
      setTimeout(() => {
        messageElement.remove();
      }, 3000);
    }
  </script>
</body>
</html>
