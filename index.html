<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>أداة توقع الشمعة القادمة</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-b from-gray-100 to-white min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl p-8">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">🔮 أداة لحظية لتوقع الشمعة التالية (5 دقائق)</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label class="block font-semibold mb-1 text-gray-700">اختر زوج العملة:</label>
        <select id="pair" class="w-full p-3 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="btcusdt">BTC/USDT</option>
          <option value="ethusdt">ETH/USDT</option>
          <option value="bnbusdt">BNB/USDT</option>
        </select>
        <button onclick="analyze()" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-xl font-semibold transition-all">🔍 تحليل لحظي</button>

        <div id="result" class="mt-6 hidden border-t pt-4">
          <h2 class="text-xl font-semibold text-gray-700 mb-2">📊 نتيجة التوقع:</h2>
          <p class="text-lg"><strong>الشمعة التالية:</strong> <span id="direction" class="font-bold text-blue-700"></span></p>
          <p class="text-lg"><strong>نسبة الثقة:</strong> <span id="confidence" class="text-green-600"></span>%</p>
          <p class="text-sm mt-2 text-gray-600"><strong>السبب:</strong> <span id="reason"></span></p>
          <div class="mt-4 bg-gray-100 p-3 rounded-xl">
            <h3 class="font-semibold text-gray-700 mb-1">📋 حالة المؤشرات الفنية:</h3>
            <ul class="text-sm text-gray-700 space-y-1" id="indicators"></ul>
          </div>
        </div>
      </div>

      <div>
        <div class="rounded-xl overflow-hidden border">
          <div id="tv-chart" class="h-[400px] w-full"></div>
        </div>
      </div>
    </div>

    <p class="text-xs text-gray-400 mt-8 text-center">⚠️ هذه الأداة تقدم تحليل لحظي بناءً على بيانات Binance الفورية. ليست نصيحة مالية.</p>
  </div>

  <script>
    function loadChart(pair) {
      new TradingView.widget({
        container_id: "tv-chart",
        autosize: true,
        symbol: `BINANCE:${pair.toUpperCase()}`,
        interval: "5",
        timezone: "Etc/UTC",
        theme: "light",
        style: "1",
        locale: "ar",
        enable_publishing: false,
        allow_symbol_change: true,
        hide_top_toolbar: true,
        hide_legend: false,
        save_image: false
      });
    }

    async function analyze() {
      const pair = document.getElementById("pair").value;
      loadChart(pair);
      const limit = 20;

      try {
        const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${pair.toUpperCase()}&interval=5m&limit=${limit}`);
        const data = await response.json();

        const closes = data.map(d => parseFloat(d[4]));
        const highs = data.map(d => parseFloat(d[2]));
        const lows = data.map(d => parseFloat(d[3]));
        const lastClose = closes[closes.length - 1];
        const prevClose = closes[closes.length - 2];
        const lastOpen = parseFloat(data[data.length - 1][1]);

        // RSI
        let gain = 0, loss = 0;
        const change = lastClose - prevClose;
        if (change > 0) gain = change;
        else loss = -change;
        const rs = gain / (loss || 1);
        const rsi = 100 - (100 / (1 + rs));

        // MACD
        const ema = (arr, period) => {
          const k = 2 / (period + 1);
          let emaArr = [arr.slice(0, period).reduce((a, b) => a + b) / period];
          for (let i = period; i < arr.length; i++) {
            emaArr.push(arr[i] * k + emaArr[emaArr.length - 1] * (1 - k));
          }
          return emaArr;
        };
        const macd = ema(closes, 12).slice(-1)[0] - ema(closes, 26).slice(-1)[0];

        // Stochastic
        const highestHigh = Math.max(...highs.slice(-14));
        const lowestLow = Math.min(...lows.slice(-14));
        const stochastic = ((lastClose - lowestLow) / (highestHigh - lowestLow)) * 100;

        // Bollinger Bands
        const avg = closes.reduce((a, b) => a + b) / closes.length;
        const stdDev = Math.sqrt(closes.map(p => Math.pow(p - avg, 2)).reduce((a, b) => a + b) / closes.length);
        const bbUpper = avg + 2 * stdDev;
        const bbLower = avg - 2 * stdDev;

        // الشمعة الأخيرة
        const candleBody = Math.abs(lastClose - lastOpen);
        const candleType = candleBody < (Math.max(...highs) - Math.min(...lows)) * 0.2 ? "دوجي/ضعيفة" : (lastClose > lastOpen ? "صاعدة" : "هابطة");

        // التقييم بالنقاط
        let scoreBuy = 0;
        let scoreSell = 0;
        const indicators = [];

        if (rsi < 35) { scoreBuy++; indicators.push(`RSI: ${rsi.toFixed(2)} (شراء)`); }
        else if (rsi > 65) { scoreSell++; indicators.push(`RSI: ${rsi.toFixed(2)} (بيع)`); }
        else indicators.push(`RSI: ${rsi.toFixed(2)} (محايد)`);

        if (stochastic < 30) { scoreBuy++; indicators.push(`Stochastic: ${stochastic.toFixed(2)} (شراء)`); }
        else if (stochastic > 70) { scoreSell++; indicators.push(`Stochastic: ${stochastic.toFixed(2)} (بيع)`); }
        else indicators.push(`Stochastic: ${stochastic.toFixed(2)} (محايد)`);

        if (macd > 0) { scoreBuy++; indicators.push(`MACD: ${macd.toFixed(4)} (صاعد)`); }
        else if (macd < 0) { scoreSell++; indicators.push(`MACD: ${macd.toFixed(4)} (هابط)`); }
        else indicators.push(`MACD: ${macd.toFixed(4)} (محايد)`);

        if (lastClose < bbLower) { scoreBuy++; indicators.push("السعر قريب من الحد السفلي لبولينجر (شراء محتمل)"); }
        else if (lastClose > bbUpper) { scoreSell++; indicators.push("السعر قريب من الحد العلوي لبولينجر (بيع محتمل)"); }
        else indicators.push("السعر داخل نطاق بولينجر (محايد)");

        if (candleType === "صاعدة") { scoreBuy++; indicators.push("شمعة صاعدة قوية"); }
        else if (candleType === "هابطة") { scoreSell++; indicators.push("شمعة هابطة قوية"); }
        else indicators.push("شمعة دوجي أو ضعيفة");

        // القرار
        let direction = "محايد";
        let confidence = 50;
        let reason = "";

        const total = Math.max(scoreBuy, scoreSell);

        if (total >= 4) {
          confidence = 90;
        } else if (total === 3) {
          confidence = 75;
        } else if (total === 2) {
          confidence = 60;
        } else {
          confidence = 50;
        }

        if (scoreBuy > scoreSell) {
          direction = "شراء (LONG)";
          reason = `توافق ${scoreBuy} مؤشرات نحو الشراء.`;
        } else if (scoreSell > scoreBuy) {
          direction = "بيع (SHORT)";
          reason = `توافق ${scoreSell} مؤشرات نحو البيع.`;
        } else {
          reason = "التوصية محايدة نتيجة توازن الإشارات.";
        }

        document.getElementById("direction").textContent = direction;
        document.getElementById("confidence").textContent = confidence;
        document.getElementById("reason").textContent = reason;
        document.getElementById("indicators").innerHTML = indicators.map(i => `<li>• ${i}</li>`).join("");
        document.getElementById("result").classList.remove("hidden");

      } catch (error) {
        alert("فشل في جلب البيانات من Binance. الرجاء المحاولة مرة أخرى.");
        console.error(error);
      }
    }
  </script>
</body>
</html>
